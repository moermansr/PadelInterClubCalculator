<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Padel Duo Calculator</title>
<style>
  :root {
    --bg: #0f172a;
    --surface: #1e293b;
    --surface2: #334155;
    --border: #475569;
    --text: #f1f5f9;
    --text-muted: #94a3b8;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --green: #22c55e;
    --green-bg: rgba(34,197,94,.12);
    --orange: #f59e0b;
    --orange-bg: rgba(245,158,11,.12);
    --red: #ef4444;
    --pink: #f472b6;
    --pink-bg: rgba(244,114,182,.1);
    --purple: #a78bfa;
    --purple-bg: rgba(167,139,250,.12);
    --radius: 12px;
    --radius-sm: 8px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
  }

  /* Header */
  header {
    background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
    border-bottom: 1px solid var(--border);
    padding: 20px 0;
    text-align: center;
  }
  header h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
  header h1 span { color: var(--accent); }
  header p { color: var(--text-muted); font-size: .85rem; margin-top: 2px; }

  /* Layout */
  .container { max-width: 1280px; margin: 0 auto; padding: 20px 16px; }
  .grid {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 20px;
    align-items: start;
  }
  @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .card-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .card-header h2 { font-size: .9rem; font-weight: 600; }
  .card-body { padding: 12px 16px; }
  .badge {
    font-size: .7rem;
    padding: 2px 8px;
    border-radius: 999px;
    font-weight: 600;
  }
  .badge-blue { background: rgba(59,130,246,.15); color: var(--accent); }
  .badge-green { background: var(--green-bg); color: var(--green); }
  .badge-pink { background: var(--pink-bg); color: var(--pink); }

  /* Sidebar */
  .sidebar { display: flex; flex-direction: column; gap: 16px; }

  /* Player list */
  .player-list { display: flex; flex-direction: column; gap: 2px; }
  .player-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: background .15s;
    user-select: none;
  }
  .player-item:hover { background: var(--surface2); }
  .player-item.selected { background: rgba(59,130,246,.08); }

  /* Custom checkbox */
  .check {
    width: 20px; height: 20px;
    border: 2px solid var(--border);
    border-radius: 5px;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
    flex-shrink: 0;
  }
  .player-item.selected .check { background: var(--accent); border-color: var(--accent); }
  .check svg { display: none; }
  .player-item.selected .check svg { display: block; }

  .player-name { flex: 1; font-weight: 500; font-size: .88rem; }
  .player-pts {
    font-size: .72rem;
    color: var(--text-muted);
    background: var(--surface2);
    padding: 1px 7px;
    border-radius: 999px;
    flex-shrink: 0;
  }

  /* Select all bar */
  .select-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 0 8px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 4px;
  }
  .select-bar label {
    font-size: .8rem;
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .select-bar label input { accent-color: var(--accent); width:15px; height:15px; }
  .side-legend {
    font-size: .7rem;
    color: var(--text-muted);
    display: flex;
    gap: 6px;
  }
  .side-legend span { opacity: .7; }

  /* Side toggle */
  .side-toggle {
    display: flex;
    flex-shrink: 0;
  }
  .side-btn {
    width: 24px; height: 20px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    font-size: .6rem;
    font-weight: 700;
    cursor: pointer;
    transition: all .15s;
    padding: 0;
    line-height: 1;
  }
  .side-btn:first-child { border-radius: 4px 0 0 4px; }
  .side-btn:last-child { border-radius: 0 4px 4px 0; }
  .side-btn:not(:first-child) { border-left: none; }
  .side-btn.active-L { background: #3b82f6; border-color: #3b82f6; color: #fff; }
  .side-btn.active-B { background: var(--border); border-color: var(--border); color: #fff; }
  .side-btn.active-R { background: #8b5cf6; border-color: #8b5cf6; color: #fff; }
  .side-btn:hover:not([class*="active-"]) { background: var(--surface2); }

  /* Settings */
  .field label {
    display: block;
    font-size: .75rem;
    color: var(--text-muted);
    margin-bottom: 3px;
    font-weight: 500;
  }
  .field input, .field select {
    width: 100%;
    padding: 7px 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: .85rem;
    outline: none;
    transition: border .15s;
  }
  .field input:focus, .field select:focus { border-color: var(--accent); }
  .field select option { background: var(--bg); }
  .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

  /* Generate button */
  .btn-generate {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background .15s, transform .1s;
  }
  .btn-generate:hover { background: var(--accent-hover); }
  .btn-generate:active { transform: scale(.98); }
  .btn-generate:disabled { opacity: .5; cursor: not-allowed; transform: none; }

  /* Add player */
  .add-player-row {
    display: flex;
    gap: 6px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
  }
  .add-player-row input {
    flex: 1;
    padding: 6px 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: .82rem;
    outline: none;
  }
  .add-player-row input:focus { border-color: var(--accent); }
  .add-player-row button {
    padding: 6px 12px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: .82rem;
    font-weight: 600;
  }

  /* Remove player btn */
  .player-remove {
    width: 22px; height: 22px;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all .15s;
    flex-shrink: 0;
    font-size: .85rem;
  }
  .player-item:hover .player-remove { opacity: 1; }
  .player-remove:hover { background: rgba(239,68,68,.15); color: var(--red); }

  /* Preferred duos */
  .duo-select-row {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .duo-select-row select {
    flex: 1;
    padding: 7px 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: .82rem;
    outline: none;
  }
  .duo-select-row select:focus { border-color: var(--accent); }
  .duo-select-row select option { background: var(--bg); }
  .duo-select-row button {
    padding: 7px 12px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: .82rem;
    font-weight: 600;
    white-space: nowrap;
  }
  .duo-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }
  .duo-chip {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    background: var(--pink-bg);
    border: 1px solid rgba(244,114,182,.2);
    border-radius: 999px;
    font-size: .78rem;
    color: var(--pink);
  }
  .duo-chip-remove {
    background: none;
    border: none;
    color: var(--pink);
    cursor: pointer;
    font-size: .85rem;
    line-height: 1;
    padding: 0 1px;
    opacity: .6;
  }
  .duo-chip-remove:hover { opacity: 1; }

  /* Results area */
  .results-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    color: var(--text-muted);
    text-align: center;
    gap: 10px;
  }
  .results-placeholder svg { opacity: .25; }

  /* Solution navigation */
  .sol-nav {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .sol-nav button {
    padding: 5px 12px;
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    font-size: .82rem;
    transition: background .15s;
  }
  .sol-nav button:hover { background: var(--border); }
  .sol-nav button:disabled { opacity: .3; cursor: not-allowed; }
  .sol-nav .sol-label {
    font-weight: 600;
    font-size: .9rem;
    min-width: 140px;
    text-align: center;
  }
  .sol-nav .sol-total {
    margin-left: auto;
    font-size: .75rem;
    color: var(--text-muted);
  }

  /* Score bar */
  .score-bar {
    display: flex;
    gap: 8px;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(30,41,59,.5);
    flex-wrap: wrap;
    align-items: center;
  }
  .score-bar .score-label {
    font-size: .72rem;
    color: var(--text-muted);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: .03em;
  }
  .score-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: .72rem;
    font-weight: 600;
  }
  .score-pill-pref { background: var(--pink-bg); color: var(--pink); }
  .score-pill-side { background: var(--purple-bg); color: var(--purple); }

  /* Rotation cards */
  .rotations { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .rotation-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }
  .rotation-header {
    padding: 10px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
  }
  .rotation-header h3 { font-size: .85rem; font-weight: 600; }
  .rotation-header .rot-total { font-size: .75rem; color: var(--text-muted); }

  .match-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
  }
  .match-row + .match-row { border-top: 1px solid rgba(71,85,105,.4); }
  .match-row.is-pref {
    background: var(--pink-bg);
    border-left: 3px solid var(--pink);
  }
  .match-row.is-conflict {
    background: rgba(239,68,68,.06);
    border-left: 3px solid var(--red);
  }
  .match-num {
    font-size: .7rem;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    width: 48px;
    flex-shrink: 0;
  }
  .match-duo {
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
    flex-wrap: wrap;
  }
  .duo-player-wrap {
    display: flex;
    align-items: center;
    gap: 0;
  }
  .duo-player {
    padding: 3px 10px;
    background: var(--surface);
    font-size: .82rem;
    font-weight: 500;
    border-radius: 999px 0 0 999px;
  }
  .duo-player-side {
    padding: 3px 6px;
    font-size: .65rem;
    font-weight: 700;
    border-radius: 0 999px 999px 0;
    text-transform: uppercase;
    min-width: 22px;
    text-align: center;
  }
  .side-L { background: rgba(59,130,246,.2); color: #60a5fa; }
  .side-R { background: rgba(139,92,246,.2); color: #a78bfa; }
  .side-B { background: rgba(71,85,105,.4); color: var(--text-muted); }
  .duo-sep { color: var(--text-muted); font-size: .75rem; }
  .match-tags {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
  }
  .match-pts {
    font-weight: 700;
    font-size: .9rem;
    color: var(--accent);
    min-width: 46px;
    text-align: right;
    flex-shrink: 0;
  }
  .match-tag {
    font-size: .65rem;
    padding: 1px 7px;
    border-radius: 999px;
    font-weight: 600;
  }
  .tag-high { background: var(--green-bg); color: var(--green); }
  .tag-low { background: var(--orange-bg); color: var(--orange); }
  .tag-pref {
    background: var(--pink-bg);
    color: var(--pink);
  }
  .tag-conflict {
    background: rgba(239,68,68,.12);
    color: var(--red);
  }

  /* Player stats */
  .stats-bar {
    padding: 14px 16px;
    border-top: 1px solid var(--border);
  }
  .stats-bar h4 {
    font-size: .72rem;
    color: var(--text-muted);
    font-weight: 600;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: .04em;
  }
  .stats-chips { display: flex; flex-wrap: wrap; gap: 5px; }
  .stat-chip {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 3px 8px;
    background: var(--surface2);
    border-radius: 999px;
    font-size: .75rem;
  }
  .stat-chip .sc-count {
    background: var(--accent);
    color: #fff;
    width: 18px; height: 18px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: .65rem;
    font-weight: 700;
  }

  /* Error message */
  .error-msg {
    background: rgba(239,68,68,.1);
    border: 1px solid rgba(239,68,68,.3);
    color: var(--red);
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    font-size: .9rem;
    margin: 16px;
  }

  /* Spinner */
  .spinner {
    width: 28px; height: 28px;
    border: 3px solid var(--surface2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin .6s linear infinite;
    margin: 0 auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<header>
  <h1><span>Padel</span> Duo Calculator</h1>
  <p>Genereer duo-indelingen voor interclub wedstrijden</p>
</header>

<div class="container">
<div class="grid">

  <!-- LEFT SIDEBAR -->
  <div class="sidebar">

    <!-- Roster card -->
    <div class="card">
      <div class="card-header">
        <h2>Spelers</h2>
        <span class="badge badge-blue" id="selectedCount">0 geselecteerd</span>
      </div>
      <div class="card-body">
        <div class="select-bar">
          <label><input type="checkbox" id="selectAll" checked> Selecteer alles</label>
          <div class="side-legend"><span>L=Links</span> <span>B=Beide</span> <span>R=Rechts</span></div>
        </div>
        <div class="player-list" id="playerList"></div>
        <div class="add-player-row">
          <input type="text" id="newName" placeholder="Naam">
          <input type="number" id="newPts" placeholder="Ptn" style="max-width:64px" value="50">
          <button onclick="addPlayer()">+</button>
        </div>
      </div>
    </div>

    <!-- Preferred Duos card -->
    <div class="card">
      <div class="card-header">
        <h2>Voorkeurs Duo's</h2>
        <span class="badge badge-pink" id="duoCount">0</span>
      </div>
      <div class="card-body">
        <div class="duo-select-row">
          <select id="duoPlayer1"></select>
          <select id="duoPlayer2"></select>
          <button onclick="addPreferredDuo()">+</button>
        </div>
        <div class="duo-chips" id="duoChips"></div>
      </div>
    </div>

    <!-- Settings card -->
    <div class="card">
      <div class="card-header"><h2>Instellingen</h2></div>
      <div class="card-body">
        <div class="row-2">
          <div class="field">
            <label>Min wedstrijden/speler</label>
            <input type="number" id="minMatches" value="1" min="0" max="3">
          </div>
          <div class="field">
            <label>Max wedstrijden/speler</label>
            <input type="number" id="maxMatches" value="3" min="1" max="3">
          </div>
        </div>
      </div>
    </div>

    <!-- Generate button -->
    <button class="btn-generate" id="btnGenerate" onclick="generate()">
      Genereer Duo's
    </button>
  </div>

  <!-- RESULTS AREA -->
  <div class="card" id="resultsCard">
    <div id="resultsContent">
      <div class="results-placeholder">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>
        <p>Selecteer spelers en klik op <strong>Genereer Duo's</strong></p>
        <p style="font-size:.8rem">Minimaal 4 spelers vereist</p>
      </div>
    </div>
  </div>

</div>
</div>

<script>
// ── Data ──
let roster = [
  { name: "Lotte P.",     pts: 50,  selected: true, side: "B" },
  { name: "Kristof V.",   pts: 100, selected: true, side: "B" },
  { name: "Kristien P.",  pts: 50,  selected: true, side: "B" },
  { name: "Elke G.",      pts: 50,  selected: true, side: "B" },
  { name: "Alexia V.",    pts: 50,  selected: true, side: "B" },
  { name: "Ruben M.",     pts: 100, selected: true, side: "B" },
  { name: "George",       pts: 100, selected: true, side: "B" },
  { name: "Dirk R.",      pts: 100, selected: true, side: "B" },
];

let preferredDuos = [];
let solutions = [];
let currentSol = 0;

// ── Roster UI ──
function renderPlayers() {
  const list = document.getElementById("playerList");
  list.innerHTML = "";
  roster.forEach((p, i) => {
    const div = document.createElement("div");
    div.className = "player-item" + (p.selected ? " selected" : "");
    div.innerHTML = `
      <div class="check">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><path d="M5 13l4 4L19 7"/></svg>
      </div>
      <span class="player-name">${esc(p.name)}</span>
      <div class="side-toggle" onclick="event.stopPropagation()">
        <button class="side-btn${p.side==='L'?' active-L':''}" onclick="setSide(${i},'L')">L</button>
        <button class="side-btn${p.side==='B'?' active-B':''}" onclick="setSide(${i},'B')">B</button>
        <button class="side-btn${p.side==='R'?' active-R':''}" onclick="setSide(${i},'R')">R</button>
      </div>
      <span class="player-pts">${p.pts} pts</span>
      <button class="player-remove" onclick="event.stopPropagation();removePlayer(${i})" title="Verwijder">&times;</button>
    `;
    div.addEventListener("click", () => { p.selected = !p.selected; renderPlayers(); });
    list.appendChild(div);
  });
  updateCount();
  renderDuoSelects();
}

function updateCount() {
  const n = roster.filter(p => p.selected).length;
  document.getElementById("selectedCount").textContent = n + " geselecteerd";
  document.getElementById("btnGenerate").disabled = n < 4;
  document.getElementById("selectAll").checked = n === roster.length && roster.length > 0;
}

document.getElementById("selectAll").addEventListener("change", (e) => {
  roster.forEach(p => p.selected = e.target.checked);
  renderPlayers();
});

function setSide(i, side) {
  roster[i].side = side;
  renderPlayers();
}

function addPlayer() {
  const nameEl = document.getElementById("newName");
  const ptsEl = document.getElementById("newPts");
  const name = nameEl.value.trim();
  const pts = parseInt(ptsEl.value) || 50;
  if (!name) return;
  roster.push({ name, pts, selected: true, side: "B" });
  nameEl.value = "";
  renderPlayers();
}

document.getElementById("newName").addEventListener("keydown", (e) => {
  if (e.key === "Enter") addPlayer();
});

function removePlayer(i) {
  const name = roster[i].name;
  roster.splice(i, 1);
  preferredDuos = preferredDuos.filter(d => d[0] !== name && d[1] !== name);
  renderPlayers();
}

function esc(s) {
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}

// ── Preferred Duos UI ──
function renderDuoSelects() {
  const selected = roster.filter(p => p.selected);
  const s1 = document.getElementById("duoPlayer1");
  const s2 = document.getElementById("duoPlayer2");
  const prev1 = s1.value, prev2 = s2.value;
  s1.innerHTML = "";
  s2.innerHTML = "";
  selected.forEach(p => {
    s1.innerHTML += `<option value="${esc(p.name)}">${esc(p.name)}</option>`;
    s2.innerHTML += `<option value="${esc(p.name)}">${esc(p.name)}</option>`;
  });
  if (selected.length >= 2) {
    s1.value = prev1 && selected.some(p => p.name === prev1) ? prev1 : selected[0].name;
    s2.value = prev2 && selected.some(p => p.name === prev2) ? prev2 : selected[1].name;
  }
  renderDuoChips();
}

function addPreferredDuo() {
  const p1 = document.getElementById("duoPlayer1").value;
  const p2 = document.getElementById("duoPlayer2").value;
  if (!p1 || !p2 || p1 === p2) return;
  const key = [p1, p2].sort().join("|||");
  if (preferredDuos.some(d => [...d].sort().join("|||") === key)) return;
  preferredDuos.push([p1, p2]);
  renderDuoChips();
}

function removePreferredDuo(idx) {
  preferredDuos.splice(idx, 1);
  renderDuoChips();
}

function renderDuoChips() {
  const container = document.getElementById("duoChips");
  document.getElementById("duoCount").textContent = preferredDuos.length;
  container.innerHTML = "";
  preferredDuos.forEach((duo, i) => {
    container.innerHTML += `<div class="duo-chip">&#9829; ${esc(duo[0])} &amp; ${esc(duo[1])}
      <button class="duo-chip-remove" onclick="removePreferredDuo(${i})">&times;</button></div>`;
  });
}

// ── Side assignment helpers ──
// Determine which side each player in a duo plays
function assignSides(p1, p2, sideMap) {
  const s1 = sideMap[p1], s2 = sideMap[p2];
  if (s1 === "L" && s2 === "R") return ["L", "R"];
  if (s1 === "R" && s2 === "L") return ["R", "L"];
  if (s1 === "L" && s2 === "B") return ["L", "R"];
  if (s1 === "B" && s2 === "L") return ["R", "L"];
  if (s1 === "R" && s2 === "B") return ["R", "L"];
  if (s1 === "B" && s2 === "R") return ["L", "R"];
  if (s1 === "L" && s2 === "L") return ["L", "L"];
  if (s1 === "R" && s2 === "R") return ["R", "R"];
  return ["B", "B"];
}

// Score a duo's side quality: L+R=2, L/R+B=1, B+B=0, L+L or R+R=-1
function duoSideScore(p1, p2, sideMap) {
  const s1 = sideMap[p1], s2 = sideMap[p2];
  if ((s1 === "L" && s2 === "R") || (s1 === "R" && s2 === "L")) return 2;
  if ((s1 === "L" && s2 === "L") || (s1 === "R" && s2 === "R")) return -1;
  if (s1 === "B" && s2 === "B") return 0;
  return 1; // one dedicated + one B
}

// ── Algorithm ──
function combinations(arr, k) {
  const result = [];
  function bt(start, combo) {
    if (combo.length === k) { result.push([...combo]); return; }
    for (let i = start; i < arr.length; i++) {
      combo.push(arr[i]);
      bt(i + 1, combo);
      combo.pop();
    }
  }
  bt(0, []);
  return result;
}

function seededRandom(seed) {
  let s = seed | 0;
  return function() {
    s |= 0; s = s + 0x6D2B79F5 | 0;
    let t = Math.imul(s ^ s >>> 15, 1 | s);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}

function shuffle(arr, rng) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function generateSchedules(rosterData, selectedNames, minPts, maxPts, mode,
                           minMatchesPerPlayer, maxMatchesPerPlayer, maxSols, seed, prefDuos) {
  const ptsMap = {};
  const sideMap = {};
  rosterData.forEach(r => { ptsMap[r.name] = r.pts; sideMap[r.name] = r.side || "B"; });
  const selSet = new Set(selectedNames);
  const players = rosterData.filter(r => selSet.has(r.name)).map(r => r.name);
  const n = players.length;
  if (n < 4) return [];

  if (n === 4) {
    minMatchesPerPlayer = 3;
    maxMatchesPerPlayer = 3;
  }

  function matchingsOfFour(four) {
    const [a,b,c,d] = four;
    return [[[a,b],[c,d]], [[a,c],[b,d]], [[a,d],[b,c]]];
  }

  const rotations = [];
  const combos = combinations(players, 4);

  for (const four of combos) {
    for (const m of matchingsOfFour(four)) {
      const [p1, p2] = m;
      const s1 = ptsMap[p1[0]] + ptsMap[p1[1]];
      const s2 = ptsMap[p2[0]] + ptsMap[p2[1]];

      if (mode === "DUO") {
        if (!(minPts <= s1 && s1 <= maxPts && minPts <= s2 && s2 <= maxPts)) continue;
      } else {
        const totPts = four.reduce((a, p) => a + ptsMap[p], 0);
        if (!(minPts <= totPts && totPts <= maxPts)) continue;
      }

      const canon = pair => [...pair].sort();
      const fourSet = new Set(four);

      if (s1 > s2) {
        const ordered = [canon(p1), canon(p2)];
        rotations.push({ ordered, sums: [s1, s2], pairKeys: pairKeys(ordered), fourSet, fourArr: [...fourSet] });
      } else if (s2 > s1) {
        const ordered = [canon(p2), canon(p1)];
        rotations.push({ ordered, sums: [s2, s1], pairKeys: pairKeys(ordered), fourSet, fourArr: [...fourSet] });
      } else {
        const o1 = [canon(p1), canon(p2)];
        const o2 = [canon(p2), canon(p1)];
        rotations.push({ ordered: o1, sums: [s1, s2], pairKeys: pairKeys(o1), fourSet, fourArr: [...fourSet] });
        rotations.push({ ordered: o2, sums: [s2, s1], pairKeys: pairKeys(o2), fourSet, fourArr: [...fourSet] });
      }
    }
  }

  function pairKeys(ordered) {
    return ordered.map(pair => [...pair].sort().join("|||"));
  }

  const rng = seededRandom(seed);
  shuffle(rotations, rng);

  const solutions = [];

  function backtrack(rotIdx, usedPairs, counts, chosen) {
    if (solutions.length >= maxSols) return;
    if (rotIdx === 3) {
      if (players.every(p => (counts[p] || 0) >= minMatchesPerPlayer)) {
        solutions.push([...chosen]);
      }
      return;
    }

    for (const rot of rotations) {
      if (solutions.length >= maxSols) return;

      let pairConflict = false;
      for (const pk of rot.pairKeys) {
        if (usedPairs.has(pk)) { pairConflict = true; break; }
      }
      if (pairConflict) continue;

      let ok = true;
      for (const p of rot.fourArr) {
        if ((counts[p] || 0) + 1 > maxMatchesPerPlayer) { ok = false; break; }
      }
      if (!ok) continue;

      for (const p of rot.fourArr) counts[p] = (counts[p] || 0) + 1;
      const newUsed = new Set(usedPairs);
      for (const pk of rot.pairKeys) newUsed.add(pk);
      chosen.push(rot);

      backtrack(rotIdx + 1, newUsed, counts, chosen);

      chosen.pop();
      for (const p of rot.fourArr) counts[p]--;
    }
  }

  backtrack(0, new Set(), {}, []);

  // Score and rank solutions
  const prefSet = new Set((prefDuos || []).map(d => [...d].sort().join("|||")));

  solutions.forEach(sol => {
    let prefScore = 0;
    let sideScore = 0;
    sol.forEach(rot => {
      rot.ordered.forEach(pair => {
        const key = [...pair].sort().join("|||");
        if (prefSet.size > 0 && prefSet.has(key)) prefScore++;
        sideScore += duoSideScore(pair[0], pair[1], sideMap);
      });
    });
    sol._prefScore = prefScore;
    sol._sideScore = sideScore;
  });

  // Sort: preferred duos first (desc), then side score (desc)
  solutions.sort((a, b) => {
    if (b._prefScore !== a._prefScore) return b._prefScore - a._prefScore;
    return b._sideScore - a._sideScore;
  });

  return solutions;
}

// ── Generate ──
function generate() {
  const btn = document.getElementById("btnGenerate");
  const content = document.getElementById("resultsContent");
  btn.disabled = true;
  btn.textContent = "Berekenen...";

  content.innerHTML = `<div class="results-placeholder"><div class="spinner"></div><p>Oplossingen berekenen...</p></div>`;

  setTimeout(() => {
    const selected = roster.filter(p => p.selected).map(p => p.name);
    const mode = "DUO";
    const minPts = 0;
    const maxPts = 9999;
    const minMatches = parseInt(document.getElementById("minMatches").value) || 0;
    const maxMatches = parseInt(document.getElementById("maxMatches").value) || 3;
    const maxSols = 200;
    const seed = 42;

    try {
      solutions = generateSchedules(roster, selected, minPts, maxPts, mode,
                                    minMatches, maxMatches, maxSols, seed, preferredDuos);
      currentSol = 0;
      if (solutions.length === 0) {
        content.innerHTML = `<div class="error-msg">Geen geldige oplossingen gevonden met deze instellingen. Probeer de puntenlimieten aan te passen of meer spelers te selecteren.</div>`;
      } else {
        renderSolution();
      }
    } catch (e) {
      content.innerHTML = `<div class="error-msg">Fout: ${esc(e.message)}</div>`;
    }

    btn.disabled = false;
    btn.textContent = "Genereer Duo's";
  }, 50);
}

// ── Render solution ──
function renderSolution() {
  const content = document.getElementById("resultsContent");
  const sol = solutions[currentSol];
  const ptsMap = {};
  const sideMap = {};
  roster.forEach(r => { ptsMap[r.name] = r.pts; sideMap[r.name] = r.side || "B"; });
  const prefSet = new Set(preferredDuos.map(d => [...d].sort().join("|||")));

  const matchCount = {};
  sol.forEach(rot => {
    rot.fourArr.forEach(p => matchCount[p] = (matchCount[p] || 0) + 1);
  });

  // Max possible side score = 6 duos * 2 = 12
  const maxSideScore = sol.length * 2 * 2; // 3 rotations * 2 duos * 2 max per duo

  let html = `
    <div class="sol-nav">
      <button onclick="prevSol()" ${currentSol === 0 ? 'disabled' : ''}>&#8592;</button>
      <span class="sol-label">Oplossing ${currentSol + 1} / ${solutions.length}</span>
      <button onclick="nextSol()" ${currentSol >= solutions.length - 1 ? 'disabled' : ''}>&#8594;</button>
      <span class="sol-total">${solutions.length} oplossing${solutions.length !== 1 ? 'en' : ''}</span>
    </div>
    <div class="score-bar">
      <span class="score-label">Ranking:</span>
      ${sol._prefScore > 0 ? `<span class="score-pill score-pill-pref">&#9829; ${sol._prefScore} voorkeursduo${sol._prefScore !== 1 ? "'s" : ''}</span>` : `<span class="score-pill" style="background:var(--surface2);color:var(--text-muted)">Geen voorkeursduo's</span>`}
      <span class="score-pill score-pill-side">L/R ${sol._sideScore} / ${maxSideScore} zijde-score</span>
    </div>
    <div class="rotations">
  `;

  sol.forEach((rot, ri) => {
    const rotTotal = rot.fourArr.reduce((a, p) => a + ptsMap[p], 0);

    html += `
      <div class="rotation-card">
        <div class="rotation-header">
          <h3>Rotatie ${ri + 1}</h3>
          <span class="rot-total">${rotTotal} pts totaal</span>
        </div>
    `;

    rot.ordered.forEach((pair, mi) => {
      const matchNr = ri * 2 + mi + 1;
      const duoPts = ptsMap[pair[0]] + ptsMap[pair[1]];
      const isHigh = mi === 0;
      const pairKey = [...pair].sort().join("|||");
      const isPref = prefSet.has(pairKey);
      const sides = assignSides(pair[0], pair[1], sideMap);
      const isConflict = (sides[0] === sides[1]) && (sides[0] === "L" || sides[0] === "R");
      const rowClass = isPref ? ' is-pref' : isConflict ? ' is-conflict' : '';

      html += `
        <div class="match-row${rowClass}">
          <span class="match-num">Match ${matchNr}</span>
          <div class="match-duo">
            <div class="duo-player-wrap">
              <span class="duo-player">${esc(pair[0])}</span>
              <span class="duo-player-side side-${sides[0]}">${sides[0]}</span>
            </div>
            <span class="duo-sep">&amp;</span>
            <div class="duo-player-wrap">
              <span class="duo-player">${esc(pair[1])}</span>
              <span class="duo-player-side side-${sides[1]}">${sides[1]}</span>
            </div>
            <div class="match-tags">
              <span class="match-tag ${isHigh ? 'tag-high' : 'tag-low'}">${isHigh ? 'Hoog' : 'Laag'}</span>
              ${isPref ? '<span class="match-tag tag-pref">&#9829; Voorkeur</span>' : ''}
              ${isConflict ? '<span class="match-tag tag-conflict">&#9888; Zelfde zijde</span>' : ''}
            </div>
          </div>
          <span class="match-pts">${duoPts} pts</span>
        </div>
      `;
    });

    html += `</div>`;
  });

  html += `</div>`;

  // Stats bar
  html += `<div class="stats-bar"><h4>Wedstrijden per speler</h4><div class="stats-chips">`;
  const sortedPlayers = Object.entries(matchCount).sort((a,b) => b[1] - a[1]);
  sortedPlayers.forEach(([name, count]) => {
    const side = sideMap[name] || "B";
    const sideLabel = side === "B" ? "" : ` (${side})`;
    html += `<div class="stat-chip"><span class="sc-count">${count}</span> ${esc(name)}${sideLabel}</div>`;
  });
  const selected = roster.filter(p => p.selected);
  selected.forEach(p => {
    if (!matchCount[p.name]) {
      html += `<div class="stat-chip" style="opacity:.5"><span class="sc-count" style="background:var(--border)">0</span> ${esc(p.name)}</div>`;
    }
  });
  html += `</div></div>`;

  content.innerHTML = html;
}

function prevSol() {
  if (currentSol > 0) { currentSol--; renderSolution(); }
}
function nextSol() {
  if (currentSol < solutions.length - 1) { currentSol++; renderSolution(); }
}

// ── Init ──
renderPlayers();
</script>
</body>
</html>
